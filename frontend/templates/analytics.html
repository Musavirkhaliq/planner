<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analytics | Productivity Planner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main class="container mt-5">
    <h2 class="mb-4">Analytics</h2>

    <div class="row mb-4">
      <div class="col-md-3">
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label>&nbsp;</label>
        <button class="btn btn-primary w-100" onclick="fetchAnalytics()">Get Analytics</button>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <canvas id="focusTimeChart"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="productivityTrendsChart"></canvas>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6">
        <canvas id="utilizationChart"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="completionRateChart"></canvas>
      </div>
    </div>
  </main>

  <script>
    function fetchAnalytics() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        if (!startDate || !endDate) {
            alert("Please select a date range.");
            return;
        }

        fetch(`/time_slots/analytics?start=${startDate}&end=${endDate}`)
            .then(response => response.json())
            .then(data => {
                updateFocusTimeChart(data);
                updateProductivityTrendsChart(data);
                updateUtilizationChart(data);
                updateCompletionRateChart(data);
            })
            .catch(error => console.error("Error fetching analytics:", error));
    }

    function updateFocusTimeChart(data) {
        const ctx = document.getElementById("focusTimeChart").getContext("2d");
        const labels = data.timeslot_analytics.map(slot => slot.start_time);
        const minutes = data.timeslot_analytics.map(slot => slot.minutes_focused);

        new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: "Minutes Focused",
                    data: minutes,
                    backgroundColor: "rgba(255, 99, 132, 0.6)",
                    borderColor: "rgba(255, 99, 132, 1)",
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function updateProductivityTrendsChart(data) {
        const ctx = document.getElementById("productivityTrendsChart").getContext("2d");
        const labels = data.productivity_trends.map(trend => trend.date);
        const focusTime = data.productivity_trends.map(trend => trend.focus_time);

        new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [{
                    label: "Daily Focus Time",
                    data: focusTime,
                    backgroundColor: "rgba(54, 162, 235, 0.6)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function updateUtilizationChart(data) {
        const ctx = document.getElementById("utilizationChart").getContext("2d");
        new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["Utilized", "Wasted"],
                datasets: [{
                    data: [data.time_slot_utilization, 100 - data.time_slot_utilization],
                    backgroundColor: ["#28a745", "#dc3545"]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: "Time Slot Utilization"
                    }
                }
            }
        });
    }

    function updateCompletionRateChart(data) {
        const ctx = document.getElementById("completionRateChart").getContext("2d");
        new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["Completed", "Incomplete"],
                datasets: [{
                    data: [data.task_completion_rate, 100 - data.task_completion_rate],
                    backgroundColor: ["#007BFF", "#6c757d"]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: "Task Completion Rate"
                    }
                }
            }
        });
    }
  </script>
</body>
</html>